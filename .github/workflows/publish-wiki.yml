name: Publish Wiki Pages

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  publish-wiki:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'publishwiki')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      - name: Find and publish wiki pages
        run: |
          set -e
          
          # Initialize git config for the wiki repo
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          cd ..

          # Find all wiki.md files
          find . -name "wiki.md" -print0 | while IFS= read -r -d '' file; do
            # Expected format: ./YEAR/projects/PROJECT_NAME/wiki.md
            # We need to extract YEAR and PROJECT_NAME
            
            # Remove leading ./ if present
            clean_path="${file#./}"
            
            # Split path into components
            IFS='/' read -r year projects_dir project_name filename <<< "$clean_path"
            
            # Verify structure match (basic check)
            if [[ "$projects_dir" == "projects" && "$filename" == "wiki.md" && -n "$year" && -n "$project_name" ]]; then
               target_name="${year}-${project_name}.md"
               echo "Publishing $file to wiki/$target_name"
               cp "$file" "wiki/$target_name"
            else
               echo "Skipping $file: does not match YEAR/projects/PROJECT_NAME/wiki.md pattern"
            fi
          done

          # Commit and push changes
          cd wiki
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "Update wiki pages from repository"
            git push
          else
            echo "No changes to publish."
          fi
