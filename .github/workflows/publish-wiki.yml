name: Publish Wiki Pages

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

jobs:
  publish-wiki:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'publishwiki')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check WIKI_TOKEN presence
        shell: bash
        run: |
          if [ -z "${{ secrets.WIKI_TOKEN }}" ]; then
            echo "WIKI_TOKEN is NOT available (empty)."
            exit 1
          else
            echo "WIKI_TOKEN is available."
          fi

      - name: Checkout wiki repository
        env:
          WIKI_TOKEN: ${{ secrets.WIKI_TOKEN }}
        run: |
          # Clone the wiki repository (<repo>.wiki.git)
          # Use env var for token to prevent logging/injection
          git clone "https://x-access-token:${WIKI_TOKEN}@github.com/${{ github.repository }}.wiki.git" wiki
          cd wiki

          default_branch="$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')"
          [ -z "$default_branch" ] && default_branch="master"
          git checkout "$default_branch"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          cd ..

      - name: Find and publish wiki pages
        env:
          WIKI_TOKEN: ${{ secrets.WIKI_TOKEN }}
        run: |
          set -e
          
          # Initialize git config for the wiki repo
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          cd ..

          # Find files matching the specific project structure
          find . -path "./*/projects/*/wiki.md" -print0 | while IFS= read -r -d '' file; do
            # Path is guaranteed to be ./YEAR/projects/PROJECT_NAME/wiki.md by the find command itself
            
            # Extract components using robust path manipulation
            project_dir="$(dirname "$file")"
            project_name="$(basename "$project_dir")"
            # Getting year: file -> project_dir (NAME) -> parent (projects) -> grandparent (YEAR)
            grandparent_dir="$(dirname "$(dirname "$project_dir")")"
            year="$(basename "$grandparent_dir")"
            
            # Sanitize project_name: replace underscores with Unicode Hyphen (U+2010) '‐'
            sanitized_project_name="${project_name//_/‐}"
               
            # Construct target name
            target_name="${year}‐${sanitized_project_name}.md"
            echo "Publishing $file to wiki/$target_name"
            cp "$file" "wiki/$target_name"
          done

          # Commit and push changes
          cd wiki
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "Update wiki pages from repository"
            branch_name=$(git rev-parse --abbrev-ref HEAD)
            # Use explicit token URL for push to ensure authentication works
            git push "https://x-access-token:${WIKI_TOKEN}@github.com/${{ github.repository }}.wiki.git" "HEAD:$branch_name"
          else
            echo "No changes to publish."
          fi
